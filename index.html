<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Face Blur UPSKK</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font & Icon -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Face API -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="sticky top-0 z-50 w-full border-b border-slate-200/50 dark:border-slate-800/50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm">
    <div class="container mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <svg class="h-8 w-8 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 
          10 10 10 10-4.48 10-10S17.52 2 
          12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 
          8-8 8 3.59 8 8-3.59 8-8 
          8zM8 11h8v2H8v-2zm-3.5-3.5c-.83 
          0-1.5-.67-1.5-1.5S3.67 4.5 
          4.5 4.5s1.5.67 1.5 
          1.5S5.33 7.5 4.5 7.5zm15 
          0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 
          1.5-1.5 1.5.67 1.5 
          1.5-.67 1.5-1.5 
          1.5zm-5.83 8.33c-1.39 1.39-3.59 
          1.39-4.98 0-.2-.2-.2-.51 
          0-.71s.51-.2.71 
          0c1.19 1.19 3.16 1.19 4.34 
          0 .2-.2.51-.2.71 0s.2.51 0 
          .71z"></path>
        </svg>
        <h2 class="text-xl font-bold text-slate-900 dark:text-white">BlurryFace by UPSKK</h2>
      </div>

      <!-- Dark/Light Toggle -->
      <button id="themeToggle" class="p-2 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-800 transition">
        <span id="themeIcon" class="material-symbols-outlined text-slate-700 dark:text-slate-200">dark_mode</span>
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="flex-grow container mx-auto px-4 py-8 sm:py-16">
    <div class="mx-auto max-w-3xl text-center">
      <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-slate-900 dark:text-white">
        Blur Faces in Your Images Instantly
      </h1>
      <p class="mt-4 text-lg text-slate-600 dark:text-slate-400">
        Protect privacy by automatically blurring faces in your photos. Upload an image and let our AI do the work, or take control with manual blurring tools.
      </p>
    </div>

    <!-- Upload -->
    <div class="mt-10 flex flex-col items-center">
      <input type="file" id="imageUpload" accept="image/*"
        class="mb-6 block text-sm text-gray-700 dark:text-gray-300 
               file:mr-4 file:py-2 file:px-4 
               file:rounded-lg file:border-0 file:text-sm file:font-semibold
               file:bg-blue-600 file:text-white hover:file:bg-blue-500 cursor-pointer"/>

      <!-- Tombol Aksi -->
      <div class="flex flex-wrap justify-center gap-3 mb-6">
        <button onclick="autoBlur()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium shadow">Blur Automatik</button>
        <button onclick="resetImage()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-medium shadow">Reset</button>
        <button onclick="undo()" class="px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-500 text-white font-medium shadow">Undo</button>
        <button onclick="redo()" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-medium shadow">Redo</button>
        <button onclick="downloadImage()" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white font-medium shadow">Download</button>
      </div>

      <!-- Canvas -->
      <div class="w-full max-w-4xl">
        <canvas id="canvas" class="border border-gray-600 rounded-xl shadow-lg w-full cursor-crosshair"></canvas>
      </div>
    </div>
  </main>

  <!-- SCRIPTS -->
  <script>
    // === Dark/Light Toggle ===
    const html = document.documentElement;
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    function updateThemeIcon() {
      if (html.classList.contains("dark")) {
        themeIcon.textContent = "light_mode";
      } else {
        themeIcon.textContent = "dark_mode";
      }
    }

    themeToggle.addEventListener("click", () => {
      html.classList.toggle("dark");
      updateThemeIcon();
    });

    updateThemeIcon();

    // === Face Blur Script (sama seperti sebelumnya) ===
    let currentImage;
    let history = [];
    let historyIndex = -1;

    async function loadFaceModels() {
      try {
        await faceapi.nets.ssdMobilenetv1.loadFromUri('https://jimswk.github.io/faceblursites/models/');
        await faceapi.nets.faceLandmark68Net.loadFromUri('https://jimswk.github.io/faceblursites/models/');
        console.log('✅ Model wajah berhasil dimuat');
      } catch (error) {
        console.error('❌ Gagal memuat model wajah:', error);
        alert('Gagal memuat model wajah. Periksa konsol.');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof faceapi === 'undefined') {
        console.error('faceapi tidak didefinisikan.');
        alert('Pustaka face-api.js gagal dimuat.');
        return;
      }
      await loadFaceModels();
      const imageUpload = document.getElementById('imageUpload');
      imageUpload.addEventListener('change', handleImageUpload);
    });

    async function handleImageUpload(event) {
      const input = event.target.files[0];
      if (!input) return;
      currentImage = await faceapi.bufferToImage(input);
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      canvas.width = currentImage.width;
      canvas.height = currentImage.height;
      ctx.drawImage(currentImage, 0, 0);
      saveState();
    }

    async function autoBlur() {
      if (!currentImage) return alert('Muat naik gambar dulu.');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(currentImage, 0, 0);
      try {
        const detections = await faceapi.detectAllFaces(currentImage).withFaceLandmarks();
        detections.forEach(detection => {
          const box = detection.detection.box;
          ctx.save();
          const centerX = box.x + box.width / 2;
          const centerY = box.y + box.height / 2;
          const radiusX = box.width / 2 * 1.1;
          const radiusY = box.height / 2 * 1.3;
          ctx.beginPath();
          ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI);
          ctx.clip();
          ctx.filter = 'blur(20px)';
          ctx.drawImage(currentImage, 0, 0, currentImage.width, currentImage.height);
          ctx.restore();
        });
        saveState();
      } catch (error) {
        console.error('❌ Gagal kesan wajah:', error);
        alert('Gagal proses gambar.');
      }
    }

    const canvas = document.getElementById('canvas');
    canvas.addEventListener('click', (event) => {
      if (!currentImage) return alert('Muatnaik gambar dahulu.');
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const clickX = (event.clientX - rect.left) * scaleX;
      const clickY = (event.clientY - rect.top) * scaleY;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      ctx.save();
      ctx.beginPath();
      ctx.ellipse(clickX, clickY, 40, 55, 0, 0, 2 * Math.PI);
      ctx.clip();
      ctx.filter = 'blur(20px)';
      ctx.drawImage(currentImage, 0, 0, currentImage.width, currentImage.height);
      ctx.restore();
      saveState();
    });

    function saveState() {
      const canvas = document.getElementById('canvas');
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }
      history.push(canvas.toDataURL());
      historyIndex++;
    }

    function resetImage() {
      if (!currentImage) return alert('Tidak ada gambar.');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(currentImage, 0, 0);
      history = [];
      historyIndex = -1;
      saveState();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const image = new Image();
        image.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(image, 0, 0);
        };
        image.src = history[historyIndex];
      } else alert('Tidak ada undo.');
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const image = new Image();
        image.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(image, 0, 0);
        };
        image.src = history[historyIndex];
      } else alert('Tidak ada redo.');
    }

    function downloadImage() {
      const canvas = document.getElementById('canvas');
      if (!canvas.width || !canvas.height) return alert('Tidak ada gambar.');
      const link = document.createElement('a');
      link.download = 'blurred_image.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>


